-- 1) Total revenue generated by male vs. female customers
SELECT
    gender,
    ROUND(SUM(transaction_amount), 2) AS total_revenue
FROM customers
GROUP BY gender;


-- 2) Which product sub_categories generate above-average sales revenue?
SELECT
    sub_category,
    ROUND(SUM(transaction_amount), 2) AS total_revenue
FROM customers
GROUP BY sub_category
HAVING SUM(transaction_amount) > (
    SELECT AVG(sub_total)
    FROM (
        SELECT SUM(transaction_amount) AS sub_total
        FROM customers
        GROUP BY sub_category
    ) AS category_totals
)
ORDER BY total_revenue DESC;


-- 3) Compare online vs. offline sales performance.
SELECT 
    sales_channel,
    COUNT(transaction_id) AS total_orders,
    ROUND(SUM(transaction_amount), 2) AS total_sales,
    ROUND(AVG(transaction_amount), 2) AS avg_sales
FROM customers
GROUP BY sales_channel
ORDER BY total_sales DESC;


-- 4) Which payment methods are most used by customers?
SELECT 
    payment_method,
    COUNT(transaction_id) AS total_orders,
    ROUND(SUM(transaction_amount), 2) AS total_revenue
FROM customers
GROUP BY payment_method
ORDER BY total_orders DESC;


-- 5) Which stores offer the highest discounts on average?
SELECT 
    store_name,
    ROUND(AVG(discount_amount), 2) AS avg_discount
FROM customers
GROUP BY store_name
ORDER BY avg_discount DESC;


-- 6) Find the top 3 products by total revenue within each sub_category?
WITH top_products AS (
    SELECT 
        category,
        product_name,
        ROUND(SUM(transaction_amount), 2) AS total_revenue,
        RANK() OVER (PARTITION BY category ORDER BY SUM(transaction_amount) DESC) AS rnk
    FROM customers
    GROUP BY category, product_name
)
SELECT 
    category,
    product_name,
    total_revenue
FROM top_products
WHERE rnk <= 3
ORDER BY category, total_revenue DESC;


-- 7) Identify top 5 loyal customers (most transactions)
SELECT 
    customer_id,
    customer_name,
    COUNT(transaction_id) AS total_transactions,
    ROUND(SUM(transaction_amount), 2) AS total_revenue
FROM customers
GROUP BY customer_id, customer_name
ORDER BY total_transactions DESC, total_revenue DESC
LIMIT 5;


-- 8) Analyze discount impact on average transaction value
WITH discount_analysis AS (
    SELECT
        CASE 
            WHEN discount_amount > 5 THEN 'Discounted' 
            ELSE 'Not Discounted' 
        END AS discount_status,
        transaction_amount
    FROM customers
)
SELECT 
    discount_status,
    ROUND(AVG(transaction_amount), 2) AS avg_transaction_value,
    COUNT(*) AS total_orders
FROM discount_analysis
GROUP BY discount_status
ORDER BY avg_transaction_value DESC;


-- 9) Identify high-value customers (top 10% by total spending)
WITH customer_spending AS (
    SELECT
        customer_id,
        ROUND(SUM(transaction_amount), 2) AS total_spending,
        NTILE(10) OVER (ORDER BY SUM(transaction_amount) DESC) AS spend_decile
    FROM customers
    GROUP BY customer_id
)
SELECT 
    customer_id,
    total_spending
FROM customer_spending
WHERE spend_decile = 1
ORDER BY total_spending DESC;


-- 10) Calculate monthly sales trends across categories?
SELECT 
    DATE_FORMAT(sales_date, '%Y-%m') AS month,
    category,
    ROUND(SUM(transaction_amount),2) AS total_sales
FROM customers
GROUP BY DATE_FORMAT(sales_date, '%Y-%m'), category
ORDER BY month, total_sales DESC;

